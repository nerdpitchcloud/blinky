name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
        default: 'minor'

permissions:
  contents: write

jobs:
  create_release:
    name: Create Manual Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Calculate new version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current version: $LATEST_TAG"
          
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          case "${{ inputs.version_type }}" in
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_MINOR=0
              NEW_PATCH=0
              ;;
            minor)
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
              ;;
          esac
          
          NEW_VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          NEW_TAG="v$NEW_VERSION"
          
          echo "New version: $NEW_TAG"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "prev_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # Check if tag already exists
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "Error: Tag $NEW_TAG already exists"
            exit 1
          fi
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "## Release ${{ steps.version.outputs.tag }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ "${{ inputs.version_type }}" == "major" ]; then
            echo "### Breaking Changes" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is a major version release with breaking changes." >> CHANGELOG.md
          else
            echo "### New Features" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This release includes new features and improvements." >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "### Changes since ${{ steps.version.outputs.prev_tag }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ "${{ steps.version.outputs.prev_tag }}" != "v0.0.0" ]; then
            git log --pretty=format:"- %s" ${{ steps.version.outputs.prev_tag }}..HEAD >> CHANGELOG.md
          else
            git log --pretty=format:"- %s" -20 >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.prev_tag }}...${{ steps.version.outputs.tag }}" >> CHANGELOG.md
      
      - name: Create and push tag
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## Release Created Successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous**: ${{ steps.version.outputs.prev_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release will be built automatically by the release workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
